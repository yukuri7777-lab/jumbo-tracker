<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jumbo Monaka Tracker 3.3</title>
<style>
/* --- デザイン設定 --- */
:root {
  --mono: #222;
  --gray: #bbb;
  --light-gray: #eee;
  --bg: #f7f7f7;
  --card-bg: #ffffff;
  --accent-choco: #6b3e26;
  --accent-vanilla: #e6d8a8;
  --accent-vanilla-text: #b8a050; 
}

* { box-sizing: border-box; outline: none; }

body {
  margin: 0;
  background: var(--bg);
  color: var(--mono);
  font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
  height: 100vh;
  display: flex;
  overflow: hidden;
}

/* ログイン画面 */
#auth-screen {
  position: fixed; inset: 0; z-index: 2000;
  background: var(--bg);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
.login-btn {
  background: #fff; color: #555;
  border: 1px solid #ddd; padding: 12px 24px;
  font-weight: bold; cursor: pointer; border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* ログアウトボタン */
.logout-btn {
    margin-top: auto; padding: 15px; text-align: center;
    font-size: 12px; color: var(--gray); cursor: pointer; text-decoration: underline;
}

/* Sidebar */
#sidebar {
  width: 260px;
  background: var(--card-bg);
  border-right: 1px solid var(--light-gray);
  display: flex;
  flex-direction: column;
  padding: 40px 0;
  box-shadow: 4px 0 20px rgba(0,0,0,0.02);
  z-index: 10;
}

.brand-title {
  text-align: center; font-weight: 800; letter-spacing: 0.1em;
  margin-bottom: 40px; font-size: 14px; color: var(--gray); text-transform: uppercase;
}

.nav-item {
  position: relative; padding: 20px 30px; cursor: pointer;
  transition: all 0.3s ease; opacity: 0.5; filter: grayscale(100%);
  display: flex; flex-direction: column; align-items: center; gap: 15px;
}

.nav-item img {
  width: 100%; max-width: 180px; height: auto; display: block;
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
  min-height: 80px; background: #eee;
}

.nav-item span { font-size: 13px; font-weight: 600; letter-spacing: 0.05em; }
.nav-item:hover { opacity: 0.8; background: #fafafa; filter: grayscale(0%); }

.nav-item.active { opacity: 1; background: #fff; filter: grayscale(0%); }
.nav-item.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
.nav-item.active img { transform: scale(1.05); }

.nav-item.choco.active::before { background: var(--accent-choco); }
.nav-item.choco.active span { color: var(--accent-choco); }

.nav-item.vanilla.active::before { background: var(--accent-vanilla); }
.nav-item.vanilla.active span { color: var(--accent-vanilla-text); }

/* Main Area */
#main { flex: 1; position: relative; padding: 40px; overflow: hidden; }

/* Toast Notification (Updated) */
#toast {
  position: fixed; top: 20px; left: 50%;
  transform: translateX(-50%) translateY(-20px);
  background: #333; color: #fff;
  padding: 12px 24px; border-radius: 30px;
  font-size: 14px; font-weight: 600; opacity: 0;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  pointer-events: none; z-index: 1000;
  display: flex; align-items: center; gap: 15px; /* ボタン横並び用 */
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }

/* Undo Button inside Toast */
.undo-btn {
    background: transparent; border: none; 
    color: #4da6ff; /* 薄い青 */
    cursor: pointer; font-weight: bold; font-size: 14px;
    padding: 0; text-decoration: underline;
}
.undo-btn:hover { color: #80c1ff; }

/* Panel Animation */
.panel {
  position: absolute; inset: 40px;
  background: var(--card-bg); border-radius: 24px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.04);
  display: flex; flex-direction: column; opacity: 0;
  transform: translateX(-50px); pointer-events: none;
  transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden;
}
.panel.active { opacity: 1; transform: translateX(0); pointer-events: all; }

/* Header */
.panel-header { padding: 30px 40px; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; }
.panel-title { font-size: 24px; font-weight: 700; }
.panel-stats { display: flex; gap: 40px; }
.stat-box { text-align: right; }
.stat-label { font-size: 11px; color: var(--gray); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; }
.stat-value { font-size: 28px; font-weight: 700; line-height: 1; }

/* Body */
.panel-body { flex: 1; display: flex; overflow: hidden; }

/* Graph */
.graph-area { width: 40%; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--light-gray); position: relative; background: #fafafa; }
.circle-graph { width: 280px; height: 280px; position: relative; }
.circle-graph svg { transform: rotate(-90deg); width: 100%; height: 100%; }
.circle-bg { fill: none; stroke: var(--light-gray); stroke-width: 12; }
.circle-progress { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1.5s cubic-bezier(0.22, 1, 0.36, 1); }
.circle-content { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.circle-score { font-size: 64px; font-weight: 800; letter-spacing: -2px; font-variant-numeric: tabular-nums; }
.circle-sub { font-size: 14px; color: var(--gray); margin-top: -5px; }

/* Interaction */
.interaction-area { width: 60%; display: flex; flex-direction: column; padding: 40px; }
.input-group { display: flex; gap: 15px; margin-bottom: 30px; align-items: flex-end; }
.field { flex: 1; display: flex; flex-direction: column; gap: 8px; }
label { font-size: 11px; font-weight: bold; color: var(--gray); }
input[type="number"], select {
  width: 100%; padding: 12px 0; border: none; border-bottom: 2px solid var(--light-gray);
  background: transparent; font-size: 16px; font-weight: 500; color: var(--mono);
  transition: border-color 0.2s; border-radius: 0;
}
input[type="number"]:focus, select:focus { border-color: var(--mono); }

button.add-btn {
  width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer;
  font-size: 24px; display: flex; align-items: center; justify-content: center;
  color: #fff; transition: transform 0.2s, box-shadow 0.2s; margin-left: 10px; flex-shrink: 0;
}
button.add-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
button.add-btn:active { transform: scale(0.95); }

.choco .circle-progress { stroke: var(--accent-choco); }
.choco .add-btn { background: var(--accent-choco); }
.choco .stat-value, .choco .circle-score { color: var(--accent-choco); }

.vanilla .circle-progress { stroke: var(--accent-vanilla); }
.vanilla .add-btn { background: var(--accent-vanilla); }
.vanilla .stat-value, .vanilla .circle-score { color: var(--accent-vanilla-text); }

/* List */
.history-list { flex: 1; overflow-y: auto; padding-right: 10px; }
.history-list::-webkit-scrollbar { width: 4px; }
.history-list::-webkit-scrollbar-thumb { background: var(--light-gray); border-radius: 2px; }

.list-header { display: flex; justify-content: space-between; padding-bottom: 10px; border-bottom: 1px solid var(--light-gray); margin-bottom: 10px; font-size: 11px; color: var(--gray); font-weight: bold; }
.list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px dashed var(--light-gray); animation: slideInList 0.4s ease forwards; opacity: 0; transform: translateX(-10px); }
@keyframes slideInList { to{opacity:1;transform:translateX(0);} }

.item-date { font-weight: 500; font-size: 14px; }
.item-meta { font-size: 12px; color: #888; margin-left: 10px; }
.item-right { display: flex; align-items: center; gap: 15px; }
.item-score { font-weight: 700; font-size: 16px; width: 50px; text-align: right; }
.delete-btn { cursor: pointer; color: var(--gray); font-size: 12px; opacity: 0; transition: opacity 0.2s; padding: 4px; }
.list-item:hover .delete-btn { opacity: 1; }
.delete-btn:hover { color: #f44; }

/* スマホ対応 */
@media (max-width: 768px) {
    body { flex-direction: column; height: auto; overflow: auto; }
    #sidebar { width: 100%; flex-direction: row; justify-content: center; padding: 10px; box-shadow: none; border-bottom: 1px solid #eee; height: auto;}
    .nav-item { padding: 10px; } .nav-item img { max-width: 60px; min-height: 40px; }
    #main { padding: 10px; height: auto; }
    .panel { position: relative; inset: 0; transform: none; opacity: 1; display: none; height: auto; border-radius: 12px;}
    .panel.active { display: flex; }
    .panel-body { flex-direction: column; }
    .graph-area, .interaction-area { width: 100%; }
    .graph-area { padding: 20px 0; border-right: none; border-bottom: 1px solid #eee; }
}
</style>
</head>
<body>

<div id="auth-screen">
  <h2 style="margin-bottom:20px;">Jumbo Tracker Login</h2>
  <button class="login-btn" id="login-button">Googleでログイン</button>
</div>

<div id="toast">
    <span id="toast-msg">Deleted!</span>
    <button id="toast-undo" class="undo-btn">元に戻す</button>
</div>

<div id="app-container" style="display:none; height:100%; width:100%; display:flex;">

  <div id="sidebar">
    <div class="brand-title">Jumbo Tracker</div>
    
    <div class="nav-item choco active" onclick="switchPanel('choco')">
      <img src="ダウンロード (1).jpeg" alt="Choco">
      <span>CHOCO</span>
    </div>
    
    <div class="nav-item vanilla" onclick="switchPanel('vanilla')">
      <img src="ダウンロード (2).jpeg" alt="Vanilla">
      <span>VANILLA</span>
    </div>

    <div class="logout-btn" onclick="logoutApp()">ログアウト</div>
  </div>

  <div id="main">

    <div class="panel choco active" id="panel-choco">
      <div class="panel-header">
        <div class="panel-title">Choco Monaka Jumbo</div>
        <div class="panel-stats">
          <div class="stat-box">
            <div class="stat-label">Total Eaten</div>
            <div class="stat-value" id="choco-count">0</div>
          </div>
        </div>
      </div>
      <div class="panel-body">
        <div class="graph-area">
          <div class="circle-graph">
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="44" class="circle-bg" />
              <circle cx="50" cy="50" r="44" class="circle-progress" id="choco-arc" stroke-dasharray="0 276.46" />
            </svg>
            <div class="circle-content">
              <div class="circle-score" id="choco-avg">0</div>
              <div class="circle-sub">Avg Score</div>
            </div>
          </div>
        </div>
        <div class="interaction-area">
          <div class="input-group">
            <div class="field">
              <label>製造経過日数 (日)</label>
              <input type="number" id="choco-days" placeholder="例: 3" min="0">
            </div>
            <div class="field">
              <label>パリパリ度 (1-5)</label>
              <select id="choco-texture">
                <option value="5" selected>5 - 最高</option>
                <option value="4">4 - 良い</option>
                <option value="3">3 - 普通</option>
                <option value="2">2 - 微妙</option>
                <option value="1">1 - しなしな</option>
              </select>
            </div>
            <button class="add-btn" onclick="addRecord('choco')">＋</button>
          </div>
          
          <div class="list-header">
            <span>DATE (RECORDED)</span>
            <span>SCORE</span>
          </div>
          <div class="history-list" id="choco-list"></div>
        </div>
      </div>
    </div>

    <div class="panel vanilla" id="panel-vanilla">
      <div class="panel-header">
        <div class="panel-title">Vanilla Monaka Jumbo</div>
        <div class="panel-stats">
          <div class="stat-box">
            <div class="stat-label">Total Eaten</div>
            <div class="stat-value" id="vanilla-count">0</div>
          </div>
        </div>
      </div>
      <div class="panel-body">
        <div class="graph-area">
          <div class="circle-graph">
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="44" class="circle-bg" />
              <circle cx="50" cy="50" r="44" class="circle-progress" id="vanilla-arc" stroke-dasharray="0 276.46" />
            </svg>
            <div class="circle-content">
              <div class="circle-score" id="vanilla-avg">0</div>
              <div class="circle-sub">Avg Score</div>
            </div>
          </div>
        </div>
        <div class="interaction-area">
          <div class="input-group">
            <div class="field">
              <label>製造経過日数 (日)</label>
              <input type="number" id="vanilla-days" placeholder="例: 10" min="0">
            </div>
            <div class="field">
              <label>パリパリ度 (1-5)</label>
              <select id="vanilla-texture">
                <option value="5" selected>5 - 最高</option>
                <option value="4">4 - 良い</option>
                <option value="3">3 - 普通</option>
                <option value="2">2 - 微妙</option>
                <option value="1">1 - しなしな</option>
              </select>
            </div>
            <button class="add-btn" onclick="addRecord('vanilla')">＋</button>
          </div>
          
          <div class="list-header">
            <span>DATE (RECORDED)</span>
            <span>SCORE</span>
          </div>
          <div class="history-list" id="vanilla-list"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyAU7wAys0B3CUKaDp1xtweRioojs_Wf6GU",
    authDomain: "jumbo-tracker.firebaseapp.com",
    projectId: "jumbo-tracker",
    storageBucket: "jumbo-tracker.firebasestorage.app",
    messagingSenderId: "456137226158",
    appId: "1:456137226158:web:c43388f414c156cab83a3f",
    measurementId: "G-2Q2HS17SXD"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // --- Global Variables ---
  let currentUser = null;
  let localData = { choco: [], vanilla: [] };
  let unsubscribes = { choco: null, vanilla: null };

  const CIRCLE_R = 44;
  const CIRCLE_CIRCUMFERENCE = 2 * Math.PI * CIRCLE_R;

  // --- Auth Functions ---
  document.getElementById('login-button').onclick = () => {
      signInWithPopup(auth, provider).catch(e => alert("ログインエラー: " + e.message));
  };

  window.logoutApp = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('app-container').style.display = 'flex';
      startListener('choco');
      startListener('vanilla');
    } else {
      currentUser = null;
      document.getElementById('auth-screen').style.display = 'flex';
      document.getElementById('app-container').style.display = 'none';
      if(unsubscribes.choco) unsubscribes.choco();
      if(unsubscribes.vanilla) unsubscribes.vanilla();
    }
  });

  // --- Data Listener (Firestore) ---
  function startListener(type) {
    if(unsubscribes[type]) unsubscribes[type]();

    const q = query(
      collection(db, "records"),
      where("uid", "==", currentUser.uid),
      where("type", "==", type),
      orderBy("createdAt", "desc")
    );

    unsubscribes[type] = onSnapshot(q, (snapshot) => {
      localData[type] = [];
      snapshot.forEach((doc) => {
        localData[type].push({ id: doc.id, ...doc.data() });
      });
      render(type, true);
    });
  }

  // --- Helper: Enable Enter Key ---
  function setupEnterKey(type) {
    const daysInput = document.getElementById(`${type}-days`);
    const textureInput = document.getElementById(`${type}-texture`);
    const handler = (e) => {
        if(e.key === 'Enter') addRecord(type);
    };
    daysInput.addEventListener('keydown', handler);
    textureInput.addEventListener('keydown', handler);
  }
  
  // 画面ロード時にエンターキーイベントを設定
  setupEnterKey('choco');
  setupEnterKey('vanilla');


  // --- User Actions ---
  window.switchPanel = (type) => {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelector(`.nav-item.${type}`).classList.add('active');
    
    document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
    document.getElementById(`panel-${type}`).classList.add('active');

    render(type, true);
  };

  window.addRecord = async (type) => {
    const daysInput = document.getElementById(`${type}-days`);
    const textureInput = document.getElementById(`${type}-texture`);
    
    const days = parseInt(daysInput.value);
    const texture = parseInt(textureInput.value);
    
    if (isNaN(days)) {
      alert("経過日数を入力してください");
      return;
    }

    const score = Math.round(900 * (texture / 5) + 100 * (days / 60));
    const dateStr = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' });

    try {
        await addDoc(collection(db, "records"), {
            uid: currentUser.uid,
            type: type,
            days: days,
            score: score,
            date: dateStr,
            createdAt: serverTimestamp()
        });
        daysInput.value = '';
        textureInput.value = '5';
        daysInput.focus();
    } catch(e) {
        console.error(e);
        alert("保存エラー。データベース設定を確認してください");
    }
  };

  // --- Delete Function (Modified: No Confirm, With Undo) ---
  window.del = async (type, id) => {
    // 1. 削除前にデータをバックアップ（元に戻すため）
    const itemBackup = localData[type].find(item => item.id === id);
    if (!itemBackup) return;

    // 2. 即座に削除
    try {
        await deleteDoc(doc(db, "records", id));

        // 3. トーストを表示（Undo機能を付与）
        showToast("Deleted!", async () => {
            // 元に戻す処理
            const { id, ...dataToRestore } = itemBackup; // IDを除外して再登録
            await addDoc(collection(db, "records"), dataToRestore);
        });

    } catch(e) {
        console.error("削除エラー:", e);
        alert("削除に失敗しました");
    }
  };

  // --- Rendering ---
  function render(type, animate = false) {
    const listEl = document.getElementById(`${type}-list`);
    const countEl = document.getElementById(`${type}-count`);
    const avgEl = document.getElementById(`${type}-avg`);
    const arcEl = document.getElementById(`${type}-arc`);
    const items = localData[type] || [];

    listEl.innerHTML = '';
    items.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.style.animationDelay = `${index * 0.05}s`;
      div.innerHTML = `
        <div>
          <span class="item-date">${item.date}</span>
          <span class="item-meta">製造後 ${item.days}日 / ${item.score}pts</span>
        </div>
        <div class="item-right">
          <span class="item-score">${item.score}</span>
          <span class="delete-btn" onclick="del('${type}', '${item.id}')">✕</span>
        </div>
      `;
      listEl.appendChild(div);
    });

    const total = items.length;
    countEl.textContent = total;
    let avgScore = 0;

    if (total > 0) {
      const sumScore = items.reduce((a, b) => a + b.score, 0);
      avgScore = Math.round(sumScore / total);
    }

    if (animate) {
      animateValue(avgEl, 0, avgScore, 1000);
      arcEl.style.transition = 'none';
      arcEl.style.strokeDasharray = `${CIRCLE_CIRCUMFERENCE} ${CIRCLE_CIRCUMFERENCE}`;
      arcEl.style.strokeDashoffset = CIRCLE_CIRCUMFERENCE;
      void arcEl.offsetWidth;
      const ratio = Math.min(avgScore / 1000, 1);
      const targetOffset = CIRCLE_CIRCUMFERENCE * (1 - ratio);
      arcEl.style.transition = 'stroke-dashoffset 1.5s cubic-bezier(0.22, 1, 0.36, 1)';
      arcEl.style.strokeDashoffset = targetOffset;
    } else {
      avgEl.textContent = avgScore;
      const ratio = Math.min(avgScore / 1000, 1);
      const targetOffset = CIRCLE_CIRCUMFERENCE * (1 - ratio);
      arcEl.style.strokeDasharray = `${CIRCLE_CIRCUMFERENCE} ${CIRCLE_CIRCUMFERENCE}`;
      arcEl.style.strokeDashoffset = targetOffset;
    }
  }

  function animateValue(obj, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      const ease = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
      obj.innerHTML = Math.floor(ease * (end - start) + start);
      if (progress < 1) {
        window.requestAnimationFrame(step);
      }
    };
    window.requestAnimationFrame(step);
  }

  // --- Toast with Undo (Modified) ---
  let toastTimeout;
  
  function showToast(message, undoCallback) {
    const toast = document.getElementById('toast');
    const msgEl = document.getElementById('toast-msg');
    const undoBtn = document.getElementById('toast-undo');

    // メッセージ設定
    msgEl.textContent = message;

    // Undoボタンの設定
    undoBtn.onclick = () => {
        if(undoCallback) undoCallback();
        toast.classList.remove('show'); // 押したらすぐ消す
    };

    // 表示
    toast.classList.add('show');

    // タイマーリセット
    if(toastTimeout) clearTimeout(toastTimeout);
    
    // 3.5秒後に消える
    toastTimeout = setTimeout(() => {
      toast.classList.remove('show');
    }, 3500);
  }
</script>
</body>
</html>
