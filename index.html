<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jumbo Monaka Cloud</title>
<style>
/* --- デザイン設定 --- */
:root {
  --mono: #222;
  --gray: #bbb;
  --light-gray: #eee;
  --bg: #f7f7f7;
  --card-bg: #ffffff;
  --accent-choco: #6b3e26;
  --accent-vanilla: #e6d8a8;
  --accent-vanilla-text: #b8a050; 
}

* { box-sizing: border-box; outline: none; }
body {
  margin: 0; background: var(--bg); color: var(--mono);
  font-family: sans-serif; height: 100vh; display: flex; overflow: hidden;
}

#auth-screen {
  position: fixed; inset: 0; z-index: 2000;
  background: var(--bg);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
.login-btn {
  background: #fff; color: #555;
  border: 1px solid #ddd; padding: 12px 24px;
  font-weight: bold; cursor: pointer; border-radius: 4px;
  display: flex; align-items: center; gap: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#user-bar {
  position: absolute; top: 10px; right: 20px; z-index: 100;
  font-size: 12px; color: var(--gray); display: flex; gap: 10px; align-items: center;
}
.logout-link { cursor: pointer; text-decoration: underline; }

#sidebar {
  width: 260px; background: var(--card-bg); border-right: 1px solid var(--light-gray);
  display: flex; flex-direction: column; padding: 40px 0; z-index: 10;
}
.brand-title { text-align: center; font-weight: 800; margin-bottom: 40px; color: var(--gray); }
.nav-item {
  padding: 20px 30px; cursor: pointer; opacity: 0.5; filter: grayscale(100%);
  display: flex; flex-direction: column; align-items: center; gap: 15px; transition: 0.3s;
}
.nav-item img { width: 100%; max-width: 180px; }
.nav-item.active { opacity: 1; background: #fff; filter: grayscale(0%); border-left: 4px solid transparent; }
.nav-item.choco.active { border-left-color: var(--accent-choco); }
.nav-item.vanilla.active { border-left-color: var(--accent-vanilla); }

#main { flex: 1; position: relative; padding: 40px; overflow: hidden; }

.panel {
  position: absolute; inset: 40px; background: var(--card-bg); border-radius: 24px;
  display: flex; flex-direction: column; opacity: 0; pointer-events: none;
  transform: translateX(-50px); transition: 0.6s;
}
.panel.active { opacity: 1; transform: translateX(0); pointer-events: all; }

.panel-header { padding: 30px 40px; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; }
.panel-title { font-size: 24px; font-weight: 700; }
.stat-value { font-size: 28px; font-weight: 700; }
.panel-body { flex: 1; display: flex; overflow: hidden; }

.graph-area { width: 40%; display: flex; justify-content: center; align-items: center; background: #fafafa; border-right: 1px solid #eee; }
.circle-graph { width: 280px; height: 280px; position: relative; }
.circle-graph svg { transform: rotate(-90deg); width: 100%; height: 100%; }
.circle-bg { fill: none; stroke: #eee; stroke-width: 12; }
.circle-progress { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1s; }
.circle-content { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.circle-score { font-size: 64px; font-weight: 800; }

.interaction-area { width: 60%; padding: 40px; display: flex; flex-direction: column; }
.input-group { display: flex; gap: 15px; margin-bottom: 30px; align-items: flex-end; }
input, select { width: 100%; padding: 12px 0; border: none; border-bottom: 2px solid #eee; font-size: 16px; background: transparent; }
.add-btn { width: 50px; height: 50px; border-radius: 50%; border: none; color: #fff; font-size: 24px; cursor: pointer; }

.history-list { flex: 1; overflow-y: auto; }
.list-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px dashed #eee; align-items: center; }
.delete-btn { cursor: pointer; color: #bbb; margin-left: 15px; font-size: 14px; }

.choco .circle-progress { stroke: var(--accent-choco); }
.choco .add-btn { background: var(--accent-choco); }
.vanilla .circle-progress { stroke: var(--accent-vanilla); }
.vanilla .add-btn { background: var(--accent-vanilla); }
</style>
</head>
<body>

<div id="auth-screen">
  <h2 style="margin-bottom:20px;">Jumbo Monaka Tracker</h2>
  <button class="login-btn" onclick="signIn()">
    <svg width="18" height="18" viewBox="0 0 18 18" style="margin-right:10px;"><path d="M17.64 9.2c0-.637-.057-1.252-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/><path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/><path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/><path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.272C4.672 5.142 6.656 3.58 9 3.58z" fill="#EA4335"/></svg>
    Googleでログイン
  </button>
</div>

<div id="app-container" style="display:none; height:100%;">
  <div id="user-bar">
    <span id="user-name">Guest</span>
    <span class="logout-link" onclick="signOutFunc()">ログアウト</span>
  </div>

  <div id="sidebar">
    <div class="brand-title">Cloud Tracker</div>
    <div class="nav-item choco active" onclick="switchPanel('choco')">
      <img src="ダウンロード (1).jpeg" alt="Choco"> <span>CHOCO</span>
    </div>
    <div class="nav-item vanilla" onclick="switchPanel('vanilla')">
      <img src="ダウンロード (2).jpeg" alt="Vanilla"> <span>VANILLA</span>
    </div>
  </div>

  <div id="main">
    <div class="panel choco active" id="panel-choco">
      <div class="panel-header">
        <div class="panel-title">Choco Monaka Jumbo</div>
        <div class="stat-value" id="choco-count">0</div>
      </div>
      <div class="panel-body">
        <div class="graph-area">
          <div class="circle-graph">
            <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="44" class="circle-bg"/><circle cx="50" cy="50" r="44" class="circle-progress" id="choco-arc" stroke-dasharray="0 276" stroke-dashoffset="276"/></svg>
            <div class="circle-content"><div class="circle-score" id="choco-avg">0</div></div>
          </div>
        </div>
        <div class="interaction-area">
          <div class="input-group">
            <div style="flex:1"><label style="font-size:12px;color:#888">経過日数</label><input type="number" id="choco-days" placeholder="例: 3"></div>
            <div style="flex:1"><label style="font-size:12px;color:#888">食感点</label><select id="choco-texture"><option value="5">5 (最高)</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select></div>
            <button class="add-btn" onclick="addRecord('choco')">＋</button>
          </div>
          <div class="history-list" id="choco-list"></div>
        </div>
      </div>
    </div>

    <div class="panel vanilla" id="panel-vanilla">
      <div class="panel-header">
        <div class="panel-title">Vanilla Monaka Jumbo</div>
        <div class="stat-value" id="vanilla-count">0</div>
      </div>
      <div class="panel-body">
        <div class="graph-area">
          <div class="circle-graph">
            <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="44" class="circle-bg"/><circle cx="50" cy="50" r="44" class="circle-progress" id="vanilla-arc" stroke-dasharray="0 276" stroke-dashoffset="276"/></svg>
            <div class="circle-content"><div class="circle-score" id="vanilla-avg">0</div></div>
          </div>
        </div>
        <div class="interaction-area">
          <div class="input-group">
            <div style="flex:1"><label style="font-size:12px;color:#888">経過日数</label><input type="number" id="vanilla-days" placeholder="例: 10"></div>
            <div style="flex:1"><label style="font-size:12px;color:#888">食感点</label><select id="vanilla-texture"><option value="5">5 (最高)</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select></div>
            <button class="add-btn" onclick="addRecord('vanilla')">＋</button>
          </div>
          <div class="history-list" id="vanilla-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithRedirect, GoogleAuthProvider, signOut, onAuthStateChanged, getRedirectResult } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAU7wAys0B3CUKaDp1xtweRioojs_Wf6GU",
    authDomain: "jumbo-tracker.firebaseapp.com",
    projectId: "jumbo-tracker",
    storageBucket: "jumbo-tracker.firebasestorage.app",
    messagingSenderId: "456137226158",
    appId: "1:456137226158:web:c43388f414c156cab83a3f",
    measurementId: "G-2Q2HS17SXD"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let unsubMap = { choco: null, vanilla: null };
  const localData = { choco: [], vanilla: [] };

  window.signIn = () => signInWithRedirect(auth, provider);
  window.signOutFunc = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('app-container').style.display = 'flex';
      document.getElementById('user-name').textContent = user.displayName;
      startListener('choco');
      startListener('vanilla');
    } else {
      currentUser = null;
      document.getElementById('auth-screen').style.display = 'flex';
      document.getElementById('app-container').style.display = 'none';
      if(unsubMap.choco) unsubMap.choco();
      if(unsubMap.vanilla) unsubMap.vanilla();
    }
  });

  function startListener(type) {
    if(unsubMap[type]) unsubMap[type]();
    const q = query(
      collection(db, "records"),
      where("uid", "==", currentUser.uid),
      where("type", "==", type),
      orderBy("createdAt", "desc")
    );

    unsubMap[type] = onSnapshot(q, (snapshot) => {
      localData[type] = [];
      snapshot.forEach((doc) => localData[type].push({ id: doc.id, ...doc.data() }));
      render(type, true);
    });
  }

  window.addRecord = async (type) => {
    const dEl = document.getElementById(`${type}-days`);
    const tEl = document.getElementById(`${type}-texture`);
    const days = parseInt(dEl.value);
    const texture = parseInt(tEl.value);
    if(isNaN(days)) return alert("日数を入力してください");

    const score = Math.round(900 * (texture / 5) + 100 * (days / 60));
    await addDoc(collection(db, "records"), {
      uid: currentUser.uid, type, days, score,
      date: new Date().toLocaleDateString('ja-JP'),
      createdAt: serverTimestamp()
    });
    dEl.value = ''; tEl.value = '5';
  };

  window.del = async (id) => {
    if(confirm("削除しますか？")) await deleteDoc(doc(db, "records", id));
  };

  window.switchPanel = (type) => {
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    document.querySelector(`.nav-item.${type}`).classList.add('active');
    document.querySelectorAll('.panel').forEach(e => e.classList.remove('active'));
    document.getElementById(`panel-${type}`).classList.add('active');
    render(type, true);
  };

  function render(type, animate) {
    const items = localData[type] || [];
    const listEl = document.getElementById(`${type}-list`);
    listEl.innerHTML = '';
    items.forEach(item => {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `<div><b>${item.date}</b><br><small>製造${item.days}日 / ${item.score}点</small></div>
                       <div style="display:flex;align-items:center"><b style="font-size:18px">${item.score}</b>
                       <span class="delete-btn" style="margin-left:10px;cursor:pointer" onclick="del('${item.id}')">✕</span></div>`;
      listEl.appendChild(div);
    });

    document.getElementById(`${type}-count`).textContent = items.length;
    const avg = items.length ? Math.round(items.reduce((a,b)=>a+b.score,0)/items.length) : 0;
    document.getElementById(`${type}-avg`).textContent = avg;
    
    const arc = document.getElementById(`${type}-arc`);
    const offset = 276 * (1 - Math.min(avg/1000, 1));
    arc.style.strokeDashoffset = offset;
  }
</script>
</body>
</html>